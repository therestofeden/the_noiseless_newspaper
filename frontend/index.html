<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Noiseless Newspaper</title>

  <!-- Distinctive Typography: Cormorant Garamond (editorial) + Outfit (modern humanist) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Warm, editorial palette - cream and ink
            cream: '#FAF7F2',
            parchment: '#F0EBE3',
            sand: '#E8E2D9',
            ink: '#1C1917',
            graphite: '#292524',
            slate: '#57534E',
            mist: '#A8A29E',
            // Accent: deep terracotta (warmth, trust)
            terra: {
              50: '#FEF7F5',
              100: '#FCEAE4',
              200: '#F9D5CD',
              300: '#F3B5A5',
              400: '#E88B71',
              500: '#DC6B4A',
              600: '#C4523A',
              700: '#A3412F',
              800: '#86382B',
              900: '#703329',
            },
            // Secondary: muted forest (calm, wisdom)
            forest: {
              50: '#F4F6F5',
              100: '#E6EBE8',
              200: '#CDD8D1',
              300: '#A9BDB0',
              400: '#7E9C88',
              500: '#5E8069',
              600: '#4A6754',
              700: '#3D5444',
              800: '#344539',
              900: '#2C3A31',
            },
            // New topic colors
            sky: {
              500: '#3B82F6',
              600: '#2563EB',
            },
            violet: {
              500: '#8B5CF6',
              600: '#7C3AED',
            },
            cyan: {
              500: '#06B6D4',
              600: '#0891B2',
            },
            amber: {
              500: '#F59E0B',
              600: '#D97706',
            },
            indigo: {
              500: '#6366F1',
              600: '#4F46E5',
            },
            emerald: {
              500: '#10B981',
              600: '#059669',
            }
          },
          fontFamily: {
            'serif': ['"Cormorant Garamond"', 'Georgia', 'serif'],
            'sans': ['Outfit', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <style>
    :root {
      --cream: #FAF7F2;
      --parchment: #F0EBE3;
      --ink: #1C1917;
      --terra: #DC6B4A;
      --forest: #5E8069;
    }

    html { scroll-behavior: smooth; }

    ::selection {
      background-color: var(--terra);
      color: white;
    }

    /* Subtle paper texture */
    .paper-bg {
      background-color: var(--cream);
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(220, 107, 74, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(94, 128, 105, 0.03) 0%, transparent 50%);
    }

    /* Grain overlay */
    .grain::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.02;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    /* Elegant animations */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes revealLine {
      from { width: 0; }
      to { width: 100%; }
    }

    .animate-fade-up { animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
    .animate-slide-down { animation: slideDown 0.5s ease-out forwards; }
    .animate-scale-in { animation: scaleIn 0.4s ease-out forwards; }

    .delay-100 { animation-delay: 0.1s; }
    .delay-200 { animation-delay: 0.2s; }
    .delay-300 { animation-delay: 0.3s; }
    .delay-400 { animation-delay: 0.4s; }
    .delay-500 { animation-delay: 0.5s; }
    .delay-600 { animation-delay: 0.6s; }

    .opacity-0 { opacity: 0; }

    /* Decorative elements */
    .ornament {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .ornament::before,
    .ornament::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, transparent, #D6D3D1, transparent);
    }

    /* Topic card hover */
    .topic-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .topic-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px -8px rgba(28, 25, 23, 0.1);
    }

    /* Vote button */
    .vote-btn {
      transition: all 0.2s ease;
    }

    .vote-btn:hover {
      transform: scale(1.08);
    }

    .vote-btn:active {
      transform: scale(0.96);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--parchment); }
    ::-webkit-scrollbar-thumb { background: #C4BFB6; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #A9A49B; }

    /* Drop cap for articles */
    .drop-cap::first-letter {
      float: left;
      font-family: 'Cormorant Garamond', serif;
      font-size: 4.5rem;
      line-height: 0.8;
      padding-right: 0.5rem;
      padding-top: 0.25rem;
      color: var(--terra);
      font-weight: 600;
    }

    /* Progress bar */
    .survival-bar {
      background: linear-gradient(90deg, var(--terra) 0%, var(--forest) 100%);
    }
  </style>
</head>
<body class="paper-bg grain font-sans text-ink antialiased">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ============================================
    // API CONFIGURATION
    // ============================================
    const API_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:8000/api/v1'
      : 'https://your-railway-app.railway.app/api/v1';  // TODO: Replace with actual Railway URL

    // Generate or get user ID (stored in localStorage)
    const getUserId = () => {
      let userId = localStorage.getItem('noiseless_user_id');
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substring(2, 15);
        localStorage.setItem('noiseless_user_id', userId);
      }
      return userId;
    };

    // ============================================
    // API SERVICE
    // ============================================
    const api = {
      // Get user's topic preferences
      getPreferences: async () => {
        const userId = getUserId();
        try {
          const res = await fetch(`${API_URL}/users/${userId}/preferences`);
          if (!res.ok) throw new Error('Failed to get preferences');
          return await res.json();
        } catch (e) {
          console.error('API error:', e);
          // Fall back to localStorage
          const saved = localStorage.getItem('noiseless_prefs');
          return saved ? JSON.parse(saved) : { selected_topics: [] };
        }
      },

      // Update user's topic preferences
      savePreferences: async (topics) => {
        const userId = getUserId();
        try {
          const res = await fetch(`${API_URL}/users/${userId}/preferences`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selected_topics: topics, topic_frequencies: {} }),
          });
          if (!res.ok) throw new Error('Failed to save preferences');
          return await res.json();
        } catch (e) {
          console.error('API error:', e);
          // Fall back to localStorage
          localStorage.setItem('noiseless_prefs', JSON.stringify({ topics }));
          return { selected_topics: topics };
        }
      },

      // Get daily article for a topic
      getDailyArticle: async (topicPath) => {
        const userId = getUserId();
        try {
          const res = await fetch(`${API_URL}/users/${userId}/daily-article?topic_path=${encodeURIComponent(topicPath)}`);
          if (!res.ok) throw new Error('Failed to get daily article');
          const data = await res.json();
          return data.article;
        } catch (e) {
          console.error('API error:', e);
          return null;
        }
      },

      // Get pending votes
      getPendingVotes: async () => {
        const userId = getUserId();
        try {
          const res = await fetch(`${API_URL}/users/${userId}/pending-votes`);
          if (!res.ok) throw new Error('Failed to get pending votes');
          const data = await res.json();
          return data.pending_votes || [];
        } catch (e) {
          console.error('API error:', e);
          return [];
        }
      },

      // Submit a vote
      submitVote: async (articleId, period, score) => {
        const userId = getUserId();
        try {
          const res = await fetch(`${API_URL}/users/${userId}/votes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ article_id: articleId, period, score }),
          });
          if (!res.ok) throw new Error('Failed to submit vote');
          return await res.json();
        } catch (e) {
          console.error('API error:', e);
          return { success: false };
        }
      },

      // Get user stats
      getStats: async () => {
        const userId = getUserId();
        try {
          const res = await fetch(`${API_URL}/users/${userId}/stats`);
          if (!res.ok) throw new Error('Failed to get stats');
          return await res.json();
        } catch (e) {
          console.error('API error:', e);
          return null;
        }
      }
    };

    // ============================================
    // TAXONOMY & DATA
    // ============================================
    const TAXONOMY = {
      // ===== DEEP TOPICS (Research-Focused) =====
      'ai-ml': {
        name: 'Artificial Intelligence',
        icon: 'â—ˆ',
        color: 'terra',
        type: 'deep',
        subtopics: {
          'deep-learning': {
            name: 'Deep Learning',
            niches: ['transformers', 'computer-vision', 'reinforcement-learning', 'generative-models']
          },
          'nlp': {
            name: 'Natural Language',
            niches: ['large-language-models', 'interpretability', 'reasoning']
          },
          'ml-systems': {
            name: 'ML Systems',
            niches: ['scaling', 'optimization', 'infrastructure']
          }
        }
      },
      'physics': {
        name: 'Physics',
        icon: 'â—‰',
        color: 'forest',
        type: 'deep',
        subtopics: {
          'quantum': {
            name: 'Quantum Physics',
            niches: ['quantum-computing', 'quantum-information', 'foundations']
          },
          'complexity': {
            name: 'Complexity Science',
            niches: ['networks', 'emergence', 'chaos-theory']
          },
          'astro': {
            name: 'Astrophysics',
            niches: ['cosmology', 'exoplanets', 'gravitational-waves']
          }
        }
      },
      'economics': {
        name: 'Economics & Finance',
        icon: 'â—‡',
        color: 'terra',
        type: 'deep',
        subtopics: {
          'macro': {
            name: 'Macroeconomics',
            niches: ['monetary-policy', 'fiscal-policy', 'international-trade']
          },
          'behavioral': {
            name: 'Behavioral Economics',
            niches: ['decision-making', 'nudges', 'experiments']
          },
          'markets': {
            name: 'Financial Markets',
            niches: ['asset-pricing', 'crypto', 'risk']
          }
        }
      },
      'biotech': {
        name: 'Biotechnology',
        icon: 'â—Ž',
        color: 'forest',
        type: 'deep',
        subtopics: {
          'genomics': {
            name: 'Genomics',
            niches: ['crispr', 'gene-therapy', 'synthetic-biology']
          },
          'neuro': {
            name: 'Neuroscience',
            niches: ['brain-interfaces', 'connectomics', 'neurodegeneration']
          },
          'pharma': {
            name: 'Drug Discovery',
            niches: ['ai-pharma', 'clinical-trials', 'personalized-medicine']
          }
        }
      },
      'politics': {
        name: 'Politics & Policy',
        icon: 'â—†',
        color: 'terra',
        type: 'deep',
        subtopics: {
          'us-politics': {
            name: 'US Politics',
            niches: ['congress', 'elections', 'executive']
          },
          'governance': {
            name: 'Governance',
            niches: ['democracy', 'tech-regulation', 'institutions']
          },
          'policy': {
            name: 'Public Policy',
            niches: ['healthcare', 'education', 'criminal-justice']
          }
        }
      },

      // ===== GENERAL TOPICS (News-Focused) =====
      'sports': {
        name: 'Sports',
        icon: 'âš½',
        color: 'sky',
        type: 'news',
        subtopics: {
          'football-soccer': {
            name: 'Football/Soccer',
            niches: ['premier-league', 'champions-league', 'world-cup', 'transfers']
          },
          'american-sports': {
            name: 'American Sports',
            niches: ['nfl', 'nba', 'mlb', 'nhl']
          },
          'tennis-golf': {
            name: 'Tennis & Golf',
            niches: ['grand-slams', 'pga-tour', 'rankings']
          },
          'olympics': {
            name: 'Olympics & Athletics',
            niches: ['track-field', 'swimming', 'winter-sports']
          }
        }
      },
      'entertainment': {
        name: 'Entertainment & Culture',
        icon: 'ðŸŽ¬',
        color: 'violet',
        type: 'news',
        subtopics: {
          'film-tv': {
            name: 'Film & Television',
            niches: ['theatrical', 'streaming', 'awards', 'industry']
          },
          'music': {
            name: 'Music',
            niches: ['albums', 'tours', 'industry', 'retrospectives']
          },
          'books': {
            name: 'Books & Literature',
            niches: ['fiction', 'nonfiction', 'awards', 'publishing']
          },
          'art': {
            name: 'Art & Design',
            niches: ['visual-arts', 'architecture', 'fashion', 'exhibitions']
          }
        }
      },
      'technology': {
        name: 'Technology',
        icon: 'ðŸ“±',
        color: 'cyan',
        type: 'news',
        subtopics: {
          'consumer-tech': {
            name: 'Consumer Tech',
            niches: ['smartphones', 'computing', 'smart-home', 'wearables']
          },
          'social-internet': {
            name: 'Social & Internet',
            niches: ['platforms', 'creator-economy', 'digital-culture', 'misinformation']
          },
          'gaming': {
            name: 'Gaming',
            niches: ['console-pc', 'mobile', 'esports', 'industry']
          },
          'cybersecurity': {
            name: 'Cybersecurity',
            niches: ['threats', 'privacy', 'regulation', 'enterprise']
          }
        }
      },
      'business': {
        name: 'Business & Markets',
        icon: 'ðŸ“ˆ',
        color: 'amber',
        type: 'news',
        subtopics: {
          'corporate': {
            name: 'Corporate News',
            niches: ['earnings', 'mergers', 'executives', 'strategy']
          },
          'startups': {
            name: 'Startups & VC',
            niches: ['funding', 'unicorns', 'founders', 'ecosystem']
          },
          'investing': {
            name: 'Markets & Investing',
            niches: ['equities', 'bonds', 'commodities', 'crypto']
          },
          'management': {
            name: 'Management & Strategy',
            niches: ['leadership', 'organizational', 'future-of-work', 'cases']
          }
        }
      },
      'world': {
        name: 'World News',
        icon: 'ðŸŒ',
        color: 'indigo',
        type: 'news',
        subtopics: {
          'geopolitics': {
            name: 'Geopolitics',
            niches: ['us-china', 'great-powers', 'trade', 'international-law']
          },
          'conflicts': {
            name: 'Conflicts & Security',
            niches: ['wars', 'terrorism', 'humanitarian', 'peacekeeping']
          },
          'diplomacy': {
            name: 'Diplomacy',
            niches: ['summits', 'treaties', 'un', 'foreign-policy']
          },
          'regions': {
            name: 'Regional News',
            niches: ['europe', 'asia', 'middle-east', 'africa', 'americas']
          }
        }
      },
      'environment': {
        name: 'Environment & Climate',
        icon: 'ðŸŒ±',
        color: 'emerald',
        type: 'news',
        subtopics: {
          'climate-science': {
            name: 'Climate Science',
            niches: ['research', 'ipcc', 'modeling', 'attribution']
          },
          'energy': {
            name: 'Energy Transition',
            niches: ['renewables', 'nuclear', 'grid', 'policy']
          },
          'conservation': {
            name: 'Conservation',
            niches: ['biodiversity', 'oceans', 'forests', 'species']
          },
          'sustainability': {
            name: 'Sustainability',
            niches: ['circular-economy', 'business', 'urban', 'food']
          }
        }
      }
    };

    const SAMPLE_ARTICLES = [
      {
        id: '1',
        title: 'Sparse Attention Patterns in Transformers: A Mathematical Framework for Computational Efficiency',
        abstract: 'We present a rigorous analysis of sparse attention mechanisms, demonstrating that carefully designed sparsity patterns can achieve 94% of dense attention quality while reducing complexity from O(nÂ²) to O(n log n). Our framework provides theoretical guarantees for attention approximation error bounds.',
        authors: [{ name: 'Sarah Chen' }, { name: 'Michael Roberts' }],
        source: 'arXiv',
        published_at: '2026-02-03',
        topic_path: 'ai-ml/deep-learning/transformers',
        citation_count: 147,
        survival_score: 0.89,
        url: '#'
      },
      {
        id: '2',
        title: 'The Persistence of Monetary Policy Effects: Evidence from Japan\'s Lost Decades',
        abstract: 'Drawing on three decades of economic data, we examine how zero interest rate policy and quantitative easing shape productivity growth, wealth distribution, and financial stability. Our findings challenge conventional assumptions about the neutrality of money.',
        authors: [{ name: 'Kenji Yamamoto' }, { name: 'Elena Volkov' }],
        source: 'NBER',
        published_at: '2026-02-02',
        topic_path: 'economics/macro/monetary-policy',
        citation_count: 328,
        survival_score: 0.94,
        url: '#'
      }
    ];

    // ============================================
    // UTILITIES
    // ============================================
    const formatDate = (dateStr) => {
      return new Date(dateStr).toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
    };

    const getTopicLabel = (path) => {
      const [domain, subtopic, niche] = path.split('/');
      const d = TAXONOMY[domain];
      if (!d) return path;
      const s = d.subtopics[subtopic];
      return s ? `${d.name} â€º ${s.name}` : d.name;
    };

    // ============================================
    // COMPONENTS
    // ============================================

    // Decorative ornament
    const Ornament = ({ className = '' }) => (
      <div className={`ornament text-terra-400 ${className}`}>
        <span className="font-serif text-lg">âœ¦</span>
      </div>
    );

    // Logo
    const Logo = ({ size = 'md', onClick }) => {
      const sizes = {
        sm: 'text-xl',
        md: 'text-2xl',
        lg: 'text-4xl md:text-5xl'
      };

      return (
        <button
          onClick={onClick}
          className={`font-serif font-medium tracking-tight ${sizes[size]} text-ink hover:text-terra-600 transition-colors`}
        >
          The Noiseless <span className="text-terra-500">Newspaper</span>
        </button>
      );
    };

    // Navigation
    const Nav = ({ currentView, setCurrentView, minimal = false }) => (
      <nav className={`sticky top-0 z-50 bg-cream/90 backdrop-blur-md border-b border-sand/50 ${minimal ? 'py-3' : 'py-4'}`}>
        <div className="max-w-4xl mx-auto px-6 flex items-center justify-between">
          <Logo size="sm" onClick={() => setCurrentView('landing')} />

          {!minimal && (
            <div className="flex items-center gap-6">
              <button
                onClick={() => setCurrentView('topics')}
                className={`font-sans text-sm tracking-wide transition-colors ${
                  currentView === 'topics' ? 'text-terra-500' : 'text-slate hover:text-ink'
                }`}
              >
                Topics
              </button>
              <button
                onClick={() => setCurrentView('votes')}
                className={`font-sans text-sm tracking-wide transition-colors ${
                  currentView === 'votes' ? 'text-terra-500' : 'text-slate hover:text-ink'
                }`}
              >
                Pending Votes
              </button>
            </div>
          )}
        </div>
      </nav>
    );

    // ============================================
    // LANDING PAGE
    // ============================================
    const LandingPage = ({ onStart, hasPrefs }) => (
      <div className="min-h-screen flex flex-col">
        {/* Hero */}
        <main className="flex-1 flex items-center justify-center px-6 py-20">
          <div className="max-w-2xl text-center">
            {/* Masthead */}
            <div className="opacity-0 animate-slide-down">
              <h1 className="font-serif text-5xl md:text-6xl lg:text-7xl font-medium text-ink leading-tight">
                The Noiseless
              </h1>
              <h1 className="font-serif text-5xl md:text-6xl lg:text-7xl font-medium text-terra-500 leading-tight -mt-2">
                Newspaper
              </h1>
            </div>

            {/* Tagline */}
            <p className="mt-6 font-sans text-xl md:text-2xl text-slate font-light tracking-wide opacity-0 animate-fade-up delay-200">
              Less <span className="line-through decoration-terra-300/50">(noise)</span> is More.
            </p>

            <Ornament className="my-10 opacity-0 animate-fade-in delay-300" />

            {/* Value prop */}
            <div className="space-y-4 opacity-0 animate-fade-up delay-300">
              <p className="font-serif text-xl md:text-2xl text-graphite leading-relaxed">
                One article per day.<br />
                Chosen for lasting value, not fleeting clicks.
              </p>

              <p className="font-sans text-slate leading-relaxed max-w-lg mx-auto">
                Our readers vote on what mattersâ€”not immediately, but after a week, a month, a year.
                We learn what survives. You read what endures.
              </p>
            </div>

            {/* CTA */}
            <div className="mt-12 opacity-0 animate-fade-up delay-400">
              <button
                onClick={onStart}
                className="group relative px-10 py-4 bg-ink text-cream font-sans font-medium tracking-wide overflow-hidden transition-all hover:shadow-xl hover:shadow-ink/10"
              >
                <span className="relative z-10">
                  {hasPrefs ? 'Continue Reading' : 'Begin Your Journey'}
                </span>
                <div className="absolute inset-0 bg-terra-500 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out" />
              </button>

              <p className="mt-4 font-sans text-sm text-mist">
                No account needed. Your preferences stay on this device.
              </p>
            </div>

            {/* How it works preview */}
            <div className="mt-20 grid grid-cols-3 gap-8 opacity-0 animate-fade-up delay-500">
              {[
                { num: '1', title: 'Choose', desc: 'Select your interests' },
                { num: '2', title: 'Read', desc: 'One article daily' },
                { num: '3', title: 'Reflect', desc: 'Vote over time' }
              ].map(step => (
                <div key={step.num} className="text-center">
                  <div className="w-10 h-10 mx-auto rounded-full bg-parchment flex items-center justify-center mb-3">
                    <span className="font-serif text-terra-500">{step.num}</span>
                  </div>
                  <h3 className="font-sans font-medium text-ink">{step.title}</h3>
                  <p className="font-sans text-sm text-mist">{step.desc}</p>
                </div>
              ))}
            </div>
          </div>
        </main>

        {/* Footer quote */}
        <footer className="py-8 text-center opacity-0 animate-fade-in delay-600">
          <p className="font-serif italic text-mist">
            "Signal survives time."
          </p>
        </footer>
      </div>
    );

    // ============================================
    // TOPIC SELECTION
    // ============================================
    const TopicSelection = ({ selectedTopics, setSelectedTopics, onContinue }) => {
      const [expanded, setExpanded] = useState({});
      const [expandedSub, setExpandedSub] = useState({});

      const toggleTopic = (path) => {
        setSelectedTopics(prev =>
          prev.includes(path)
            ? prev.filter(t => t !== path)
            : [...prev, path]
        );
      };

      return (
        <div className="max-w-3xl mx-auto px-6 py-12">
          {/* Header */}
          <header className="text-center mb-12 opacity-0 animate-fade-up">
            <h2 className="font-serif text-4xl text-ink mb-3">What Interests You?</h2>
            <p className="font-sans text-slate">
              Select topics to build your reading profile. The more specific, the better.
            </p>
          </header>

          {/* Categories */}
          <div className="space-y-4">
            {Object.entries(TAXONOMY).map(([domainKey, domain], idx) => (
              <div
                key={domainKey}
                className="opacity-0 animate-fade-up"
                style={{ animationDelay: `${(idx + 1) * 100}ms` }}
              >
                {/* Domain header */}
                <button
                  onClick={() => setExpanded(prev => ({ ...prev, [domainKey]: !prev[domainKey] }))}
                  className={`w-full p-5 rounded-xl border-2 transition-all topic-card ${
                    expanded[domainKey]
                      ? 'border-terra-200 bg-white shadow-sm'
                      : 'border-sand bg-white/60 hover:bg-white hover:border-terra-100'
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <span className={`text-2xl ${domain.color === 'terra' ? 'text-terra-400' : 'text-forest-400'}`}>
                        {domain.icon}
                      </span>
                      <span className="font-serif text-xl text-ink">{domain.name}</span>
                    </div>
                    <div className="flex items-center gap-3">
                      {selectedTopics.filter(t => t.startsWith(domainKey)).length > 0 && (
                        <span className="px-2 py-1 bg-terra-100 text-terra-700 text-xs font-sans rounded-full">
                          {selectedTopics.filter(t => t.startsWith(domainKey)).length} selected
                        </span>
                      )}
                      <svg
                        className={`w-5 h-5 text-mist transition-transform ${expanded[domainKey] ? 'rotate-180' : ''}`}
                        fill="none" viewBox="0 0 24 24" stroke="currentColor"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </div>
                  </div>
                </button>

                {/* Subtopics */}
                {expanded[domainKey] && (
                  <div className="mt-2 ml-4 space-y-2 animate-fade-in">
                    {Object.entries(domain.subtopics).map(([subKey, sub]) => (
                      <div key={subKey}>
                        <button
                          onClick={() => setExpandedSub(prev => ({
                            ...prev,
                            [`${domainKey}/${subKey}`]: !prev[`${domainKey}/${subKey}`]
                          }))}
                          className={`w-full p-4 rounded-lg border transition-all text-left ${
                            expandedSub[`${domainKey}/${subKey}`]
                              ? 'border-forest-200 bg-forest-50/50'
                              : 'border-parchment bg-parchment/30 hover:bg-parchment/60'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <span className="font-sans font-medium text-graphite">{sub.name}</span>
                            <svg
                              className={`w-4 h-4 text-mist transition-transform ${
                                expandedSub[`${domainKey}/${subKey}`] ? 'rotate-180' : ''
                              }`}
                              fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            >
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                          </div>
                        </button>

                        {/* Niches */}
                        {expandedSub[`${domainKey}/${subKey}`] && (
                          <div className="mt-2 ml-4 flex flex-wrap gap-2 animate-fade-in">
                            {sub.niches.map(niche => {
                              const path = `${domainKey}/${subKey}/${niche}`;
                              const isSelected = selectedTopics.includes(path);
                              return (
                                <button
                                  key={niche}
                                  onClick={() => toggleTopic(path)}
                                  className={`px-4 py-2 rounded-full text-sm font-sans transition-all ${
                                    isSelected
                                      ? 'bg-terra-500 text-white shadow-md shadow-terra-500/20'
                                      : 'bg-white border border-sand text-slate hover:border-terra-200 hover:text-ink'
                                  }`}
                                >
                                  {niche.replace(/-/g, ' ')}
                                </button>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>

          {/* Selected summary */}
          {selectedTopics.length > 0 && (
            <div className="mt-8 p-5 bg-white rounded-xl border border-sand animate-scale-in">
              <h3 className="font-sans font-medium text-ink mb-3">
                Selected ({selectedTopics.length})
              </h3>
              <div className="flex flex-wrap gap-2">
                {selectedTopics.map(path => (
                  <span
                    key={path}
                    className="px-3 py-1 bg-terra-50 text-terra-700 rounded-full text-sm font-sans"
                  >
                    {path.split('/').pop().replace(/-/g, ' ')}
                  </span>
                ))}
              </div>
            </div>
          )}

          {/* Continue */}
          <div className="mt-12 text-center">
            <button
              onClick={onContinue}
              disabled={selectedTopics.length === 0}
              className={`px-10 py-4 font-sans font-medium tracking-wide transition-all ${
                selectedTopics.length > 0
                  ? 'bg-ink text-cream hover:bg-graphite hover:shadow-lg'
                  : 'bg-sand text-mist cursor-not-allowed'
              }`}
            >
              Continue to Your Daily Article
            </button>
          </div>
        </div>
      );
    };

    // ============================================
    // DAILY ARTICLE VIEW
    // ============================================
    const DailyArticle = ({ article }) => (
      <div className="max-w-2xl mx-auto px-6 py-12">
        {/* Date header */}
        <div className="text-center mb-12 opacity-0 animate-slide-down">
          <p className="font-sans text-sm text-mist tracking-widest uppercase">
            {new Date().toLocaleDateString('en-US', { weekday: 'long' })}
          </p>
          <p className="font-serif text-2xl text-ink mt-1">
            {formatDate(new Date().toISOString())}
          </p>
        </div>

        <article className="opacity-0 animate-fade-up delay-200">
          {/* Topic badge */}
          <div className="mb-6">
            <span className="inline-block px-4 py-1.5 bg-forest-50 text-forest-700 rounded-full text-sm font-sans">
              {getTopicLabel(article.topic_path)}
            </span>
          </div>

          {/* Title */}
          <h1 className="font-serif text-3xl md:text-4xl lg:text-5xl text-ink leading-tight mb-6">
            {article.title}
          </h1>

          {/* Meta */}
          <div className="flex flex-wrap items-center gap-3 text-sm font-sans text-mist mb-8">
            <span>{article.authors.map(a => a.name).join(', ')}</span>
            <span className="text-sand">â€¢</span>
            <span>{article.source}</span>
            <span className="text-sand">â€¢</span>
            <span>{formatDate(article.published_at)}</span>
          </div>

          {/* Decorative line */}
          <div className="h-px bg-gradient-to-r from-transparent via-sand to-transparent mb-8" />

          {/* Abstract with drop cap */}
          <div className="drop-cap font-serif text-xl text-graphite leading-relaxed">
            {article.abstract}
          </div>

          {/* Survival indicator */}
          <div className="mt-12 p-6 bg-parchment/50 rounded-xl opacity-0 animate-fade-up delay-300">
            <div className="flex items-center justify-between mb-3">
              <span className="font-sans text-sm font-medium text-slate">Predicted Lasting Value</span>
              <span className="font-sans text-sm font-semibold text-terra-600">
                {Math.round(article.survival_score * 100)}%
              </span>
            </div>
            <div className="h-2 bg-sand rounded-full overflow-hidden">
              <div
                className="h-full survival-bar rounded-full transition-all duration-1000"
                style={{ width: `${article.survival_score * 100}%` }}
              />
            </div>
            <p className="mt-3 font-sans text-xs text-mist">
              Based on {article.citation_count} citations and patterns from articles readers found valuable over time.
            </p>
          </div>

          {/* CTA */}
          <div className="mt-10 text-center opacity-0 animate-fade-up delay-400">
            <a
              href={article.url}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-flex items-center gap-2 px-8 py-3 bg-ink text-cream font-sans font-medium hover:bg-graphite transition-colors"
            >
              Read Full Article
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          </div>

          <Ornament className="my-12 opacity-0 animate-fade-in delay-500" />

          {/* Voting reminder */}
          <div className="text-center opacity-0 animate-fade-up delay-500">
            <p className="font-serif text-xl text-slate mb-3">
              We'll ask you about this article in 1 week.
            </p>
            <p className="font-sans text-sm text-mist">
              Did it stay with you? Your vote helps others find signal in the noise.
            </p>
          </div>
        </article>
      </div>
    );

    // ============================================
    // PENDING VOTES
    // ============================================
    const VoteCard = ({ article, period, onVote }) => {
      const [score, setScore] = useState(null);
      const [done, setDone] = useState(false);

      const labels = {
        '1_week': 'One Week Later',
        '1_month': 'One Month Later',
        '1_year': 'One Year Later'
      };

      const questions = {
        '1_week': 'Did this article stay with you?',
        '1_month': 'Was this still relevant to your thinking?',
        '1_year': 'Did this fundamentally change how you see things?'
      };

      const handleSubmit = () => {
        if (score) {
          onVote(article.id, period, score);
          setDone(true);
        }
      };

      if (done) {
        return (
          <div className="p-8 bg-white rounded-xl border border-forest-200 text-center animate-scale-in">
            <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-forest-50 flex items-center justify-center">
              <svg className="w-8 h-8 text-forest-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <p className="font-serif text-xl text-ink">Thank you</p>
            <p className="font-sans text-sm text-mist mt-1">Your vote helps others find signal.</p>
          </div>
        );
      }

      return (
        <div className="p-6 bg-white rounded-xl border border-sand shadow-sm topic-card">
          {/* Period badge */}
          <span className={`inline-block px-3 py-1 rounded-full text-xs font-sans font-medium mb-4 ${
            period === '1_year' ? 'bg-terra-100 text-terra-700' :
            period === '1_month' ? 'bg-forest-100 text-forest-700' :
            'bg-parchment text-slate'
          }`}>
            {labels[period]}
          </span>

          {/* Title */}
          <h3 className="font-serif text-xl text-ink mb-2 line-clamp-2">{article.title}</h3>
          <p className="font-sans text-sm text-mist mb-6">
            {article.source} â€¢ {formatDate(article.published_at)}
          </p>

          {/* Question */}
          <p className="font-sans text-slate mb-6">{questions[period]}</p>

          {/* Vote buttons */}
          <div className="flex justify-center gap-3 mb-4">
            {[1, 2, 3, 4, 5].map(n => (
              <button
                key={n}
                onClick={() => setScore(n)}
                className={`vote-btn w-12 h-12 rounded-full font-sans font-medium ${
                  score === n
                    ? 'bg-terra-500 text-white shadow-lg shadow-terra-500/30'
                    : 'bg-parchment text-slate hover:bg-terra-100'
                }`}
              >
                {n}
              </button>
            ))}
          </div>
          <div className="flex justify-between text-xs font-sans text-mist mb-6 px-2">
            <span>Not at all</span>
            <span>Profoundly</span>
          </div>

          {/* Submit */}
          <button
            onClick={handleSubmit}
            disabled={!score}
            className={`w-full py-3 font-sans font-medium transition-all ${
              score
                ? 'bg-ink text-cream hover:bg-graphite'
                : 'bg-sand text-mist cursor-not-allowed'
            }`}
          >
            Submit Vote
          </button>
        </div>
      );
    };

    const PendingVotes = ({ pendingVotes, onVote }) => {
      if (pendingVotes.length === 0) {
        return (
          <div className="max-w-2xl mx-auto px-6 py-20 text-center">
            <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-parchment flex items-center justify-center">
              <svg className="w-10 h-10 text-mist" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <h2 className="font-serif text-3xl text-ink mb-3">All Caught Up</h2>
            <p className="font-sans text-slate">No pending votes. Check back later!</p>
          </div>
        );
      }

      return (
        <div className="max-w-3xl mx-auto px-6 py-12">
          <header className="text-center mb-12">
            <h2 className="font-serif text-4xl text-ink mb-3">Time to Reflect</h2>
            <p className="font-sans text-slate">
              How did these articles hold up over time?
            </p>
          </header>

          <div className="space-y-6">
            {pendingVotes.map((vote, i) => (
              <div
                key={`${vote.article.id}-${vote.period}`}
                className="opacity-0 animate-fade-up"
                style={{ animationDelay: `${i * 100}ms` }}
              >
                <VoteCard
                  article={vote.article}
                  period={vote.period}
                  onVote={onVote}
                />
              </div>
            ))}
          </div>
        </div>
      );
    };

    // ============================================
    // MAIN APP
    // ============================================
    const App = () => {
      const [view, setView] = useState('landing');
      const [topics, setTopics] = useState([]);
      const [article, setArticle] = useState(SAMPLE_ARTICLES[0]);
      const [pendingVotes, setPendingVotes] = useState([]);
      const [loading, setLoading] = useState(true);
      const [useApi, setUseApi] = useState(true);  // Toggle for API vs localStorage

      // Load preferences on mount
      useEffect(() => {
        const loadData = async () => {
          setLoading(true);
          try {
            if (useApi) {
              // Try API first
              const prefs = await api.getPreferences();
              const savedTopics = prefs.selected_topics || [];
              setTopics(savedTopics);

              if (savedTopics.length > 0) {
                // Load daily article
                const firstTopic = savedTopics[0].split('/')[0];  // Get main topic
                const dailyArticle = await api.getDailyArticle(savedTopics[0]);
                if (dailyArticle) setArticle(dailyArticle);

                // Load pending votes
                const votes = await api.getPendingVotes();
                setPendingVotes(votes.map(v => ({ article: v.article, period: v.period })));

                setView('daily');
              }
            } else {
              // Fall back to localStorage
              const saved = localStorage.getItem('noiseless_prefs');
              if (saved) {
                const prefs = JSON.parse(saved);
                setTopics(prefs.topics || []);
                if (prefs.topics?.length > 0) {
                  setView('daily');
                }
              }
            }
          } catch (e) {
            console.error('Failed to load data:', e);
            // Fall back to sample data
            setPendingVotes([
              { article: SAMPLE_ARTICLES[0], period: '1_week' },
              { article: SAMPLE_ARTICLES[1], period: '1_month' },
            ]);
          }
          setLoading(false);
        };

        loadData();
      }, [useApi]);

      // Save preferences when topics change
      useEffect(() => {
        if (topics.length > 0 && !loading) {
          if (useApi) {
            api.savePreferences(topics);
          }
          localStorage.setItem('noiseless_prefs', JSON.stringify({ topics }));
        }
      }, [topics, useApi, loading]);

      // Load article when topics change
      useEffect(() => {
        const loadArticle = async () => {
          if (topics.length > 0 && useApi && view === 'daily') {
            const dailyArticle = await api.getDailyArticle(topics[0]);
            if (dailyArticle) setArticle(dailyArticle);
          }
        };
        loadArticle();
      }, [topics, view, useApi]);

      const handleVote = async (articleId, period, score) => {
        if (useApi) {
          await api.submitVote(articleId, period, score);
        }
        setPendingVotes(prev =>
          prev.filter(v => !(v.article.id === articleId && v.period === period))
        );
        console.log('Vote:', { articleId, period, score });
      };

      return (
        <div className="min-h-screen">
          {view !== 'landing' && (
            <Nav currentView={view} setCurrentView={setView} />
          )}

          {view === 'landing' && (
            <LandingPage
              onStart={() => setView(topics.length > 0 ? 'daily' : 'topics')}
              hasPrefs={topics.length > 0}
            />
          )}

          {view === 'topics' && (
            <TopicSelection
              selectedTopics={topics}
              setSelectedTopics={setTopics}
              onContinue={() => setView('daily')}
            />
          )}

          {view === 'daily' && (
            <DailyArticle article={article} />
          )}

          {view === 'votes' && (
            <PendingVotes pendingVotes={pendingVotes} onVote={handleVote} />
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
